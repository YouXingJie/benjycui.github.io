---
layout: article
title: 一种优化频繁地增删js字符串中字符的方法
category: js
---

由于最近在编写的一个代码处理工具需要在字符串中频繁地增删字符，所以必需要找到一种高效的方法以保证性能。但是由于编程中常用到的字符串处理是替换和拼接，所以网上找到的资料都是关注如何高性能地拼接字符串。最终只能自己瞎折腾，没想到居然还真的找到了一个相对较快的方案。

程序快慢当然要有一个对比的标准，所以以下先放我在网上找到的增删字符串中字符的方法。

### 简单的增删字符方法

以需要插入、删除字符的位置为分界，用substring截取两个子串，然后把它们拼接到一起：

{% highlight javascript %}
var str = "HelloWrold";
for (var i = 0; i < 99999; i++) {
  if (i % 2 === 0) {
    // 在Hello后增加一个空格
    str = str.substring(0, 5) + " " + str.substring(5);
  } else {
    // 把Hello后的空格删除
    str = str.substring(0, 5) + str.substring(6);
  }
}
console.log(str);
{% endhighlight%}

由于js中的字符串是不可变的，无论是substring方法，还是拼接操作，都会生成新的字符串，所以上面这个方法不仅会消耗大量的内存，在把原字符串中的字符复制到新字符串中时也会占用大量的时间。这也是这个方法低效的主要原因。

### 优化的增删字符方法

把字符串转为数组，找到需要增删字符位置对应的项并修改。在所有的修改完成后，调用数组的join方法以生成新的字符串：

{% highlight javascript %}
var str = "HelloWorld";
var arr = [].slice.call(str);
for (var i = 0; i < 99999; i++) {
  if (i % 2 === 0) {
    // 在o后增加一个空格
    arr[4] += " ";
  } else {
    // 把o后的空格删除
    arr[4] = arr[4].substr(0, 1);
  }
}
str = arr.join("");
console.log(str);
{% endhighlight%}

这过程好像有点复杂，所以我会进一步解释：

1. 把字符串"HelloWorld"转为数组["H", "e", "l", "l", "o", "W", "o", "r", "l", "d"]。
2. 往"o"之后或者说是"W"之前加入一个空格，只要找到"o"所在的项，并把"o"替换为"o "即可，当然也可以把"W"替换为" W"，join后的结果是一样的。但绝不要直接修改数组本身，比如在"o"、"W"两项之间插入" "，因为这会导致数组元素的移动，所以反而比第一个方法还慢。
3. 要删除"o"之后的空格，只要把"o "替换为"o"即可。

优化的方案也会新建字符串，不过长度都比较小，所以消耗的资源还是比第一个方案要少，自然也就更快。

从[jsPerf测试的结果](http://jsperf.com/the-fastest-way-to-edit-string)可以看到，优化后的方法比第一种方法要快60%左右。这优化的程度似乎不大，其实是因为用于测试的字符串"HelloWorld"只有10个字符，所以创建新字符串的成本不高，如果字符串长度达1W以上时（代码处理时输入的字符串长度达到1W以上也是比较常见的），优化的结果将会非常明显，有兴趣的可以测试一下。
